C==== this FISH6 routine copyright M.Grimsom, Institute of Food Research
C==== Norwich, 1987.
c==== what is variable IB ????? (found by chance RKH 23/3/93) search for IB
C SCATTERING INTENSITY FROM POLYDISPERSE MICROEMULSION DROPLET SYSTEM
C WITH EXCESS SURFACTANT PRESENT AS MICELLES
C N-COMPONENT HARD SPHERE MIXTURE MODEL
C PERCUS-YEVICK EQUATION
c	OPTIONS/CHECK=ALL
	SUBROUTINE MODEL
C==== THIS ROUTINE AVAILABLE ONLY AT UEA/FRI ETC.
      RETURN
      END
c
c
c**************************************************************************
c
c
c		Desmearing of USAXS data based on method of Vonk
c			J.Appl.Cryst.4,340(1971)
c
c
c**************************************************************************
C==== put together by A.North, Univ of Kent for Institute of Food Research
C==== Norwich, 1987, with thanks to Chris Vonk for use of his routines
	SUBROUTINE DESMEAR
	IMPLICIT DOUBLE PRECISION(A-H,O-Z)
	DIMENSION X(600),SMINT(600),TR(100),YTR(100),FINTS(600),
     *  ROOT(600),DESMI(600)
	REAL*4 RSPARE,C,Q2,E,RBIN
	COMMON/CH/IS,ID,IL,JS,JD,JF,JL,JP
        INCLUDE 'FISHDIM.PAR'
        COMMON/ONE/NCH(MW),NC(MW,5),NIC(MW,5),LAB(3,MW),LAB2(20,3,MW)
	1,RSPARE(10,MW),C(MN,MW),Q2(MN,MW),E(MN,MW),NDIM
	COMMON/BINPAR/NBIN(6),RBIN(5)
	CHARACTER*1 YSNO
	return
1	WRITE(JS,50)
	READ(IS,51,ERR=1)INSET
50	FORMAT(/' Enter set number to be desmeared ',$)
51	FORMAT(I2)
52	FORMAT(' Enter set for desmeared data ',$)
53	FORMAT(1A1)
54	FORMAT(/' OK ? (Y/N) ',$)
55	FORMAT(1X,'Enter label ',$)
56	FORMAT(3A4)
	WRITE(JS,52)
	READ(IS,51,ERR=1)IOUTSET
	NCH(IOUTSET)=NCH(INSET)
	DO I=1,5
	NC(IOUTSET,I)=NC(INSET,I)
	NIC(IOUTSET,I)=NIC(INSET,I)
	END DO
	WRITE(JS,55)
	READ(IS,56,ERR=1)LAB(1,IOUTSET)
	CALL LEXI(0)
	WRITE(JS,54)
	READ(IS,53,ERR=1)YSNO
	IF(YSNO.EQ.'N')GOTO 1
	ITEL=NC(INSET,5)-NC(INSET,4)
	I=0
	DO J=NC(INSET,4),NC(INSET,5)
	I=I+1
	X(I)=DBLE(Q2(J,INSET))
	SMINT(I)=DBLE(C(J,INSET))
	ENDDO
	kt=0
	BGR=0.0
	NPOINT=3
	IPRINT=0
	if(kt.eq.0)then
	C3=SMINT(ITEL)*X(ITEL)**5
	do j=1,100
	ytr(j)=0.0
	tr(j)=0.0
	enddo
	else
	c3=0.0
	endif
	CALL LSDES4(X,SMINT,DESMI,NPOINT,ITEL,FINTS,ROOT,
     *	YTR,TR,IPRINT,BGR,C3)
	SDV=0
	DO 390 I=1,ITEL
	DESMI(I)=DESMI(I)
c==== what is IB ?????
	IF(I.LE.IB) SDV=SDV+ROOT(I)**2
	DES2=DESMI(I)*X(I)**2*0.00000001
	DIFF=SMINT(I)-FINTS(I)
	IF(FINTS(I).LT.1D-05)DIFF=0
	PROC=100.0*DIFF/SMINT(I)
390	CONTINUE
	DO J=1,ITEL
	C(J,IOUTSET)=SNGL(DESMI(J))
	Q2(J,IOUTSET)=SNGL(X(J))
	END DO
	RETURN
	END
c
c	SUBROUTINE LSDES4
c
c
	SUBROUTINE LSDES4(X,SMI,DESM,N,IMX,SMCAL,ROOT,YTR,TR,
     *  IPRINT,BG,C3)
	IMPLICIT DOUBLE PRECISION(A-H,O-Z)
	DIMENSION COEF(161,161),A(160),B1(600),B2(600),B3(600),X(600),
     *	SMI(600),MRAR(161),MKAR(161),ROOT(600),K(600),SMCAL(600),
     *	DESM(600),CTAIL(600),YTR(100),TR(100),AC(2)
	IMX3=IMX-1
	DESM(1)=0.0
	DESM(IMX)=0.0
10	IF(IMX.GT.(N*160))GOTO 62
C
C
C
C	DO LOOP TAKES CARE OF N EXECUTIONS FOR DIFFERENT STATING I
C
C
20	DO IR=1,N
C
C
C	CALCULATE COEEFICIENTS FOR INTERPOLATION 
C
C
	NRJ=IMX-IR-1
	JRMX=NRJ/N +2
	IF(MOD(NRJ,N).NE.0) JRMX=JRMX+1
	JRMX1=JRMX+1
C
C	BEGIN CALC OF B1 ETC.
C
	K1=1
	K2=2
	K3=3
	J1=1
	J2=IR+1
 	J3=IR+N+1
	X21=X(J2)-X(J1)
	X31=X(J3)-X(J1)
	X32=X(J3)-X(J2)
	XA2=0.5*(2.0*X(J2)-X(J1)-X(J3))
	Q=2.0/X31
	RN=1.0-Q**2*XA2**2
	DO  J=1,IMX
	IF((X(J)-X(J2))/X32.LT.0.5)GOTO22
	IF(K3.EQ.JRMX)GOTO22
	K1=K2
	K2=K3
	K3=K3+1
	J1=J2
	J2=J3
	J3=J3+N
	IF(J3.GT.IMX)J3=IMX
	X21=X(J2)-X(J1)
	X31=X(J3)-X(J1)
	X32=X(J3)-X(J2)
	XA2=0.5*(2.0*X(J2)-X(J1)-X(J3))
	Q=2.0/X31
	RN=1.0-Q**2*XA2**2
22	XAJ=0.5*(2.0*X(J)-X(J1)-X(J3))
	RJ=(1-Q**2*XAJ**2)/RN
	B1(J)=(X(J3)-X(J)-X32*RJ)/X31
	B2(J)=RJ
	B3(J)=(X(J)-X(J1)-X21*RJ)/X31
C
C	STORE K(J) WHICH IS SERIAL NO.OF J1 SO NOW ON WHICH
C		POINTS INTERPOLATION WAS BASED
C
	K(J)=K1
	END DO
	DO JR2=1,JRMX
	COEF(JR2,JRMX1)=0.
	DO KR2=1,JRMX
	COEF(JR2,KR2)=0.
	ENDDO
	ENDDO
	DO 40 I=1,IMX
	W=1.
	Y1=0.
	IF(IR.NE.1) GOTO 26
	AJMX=DACOS(X(I)/X(IMX))
	IF (AJMX.GT.1.42) GOTO27
	STAX=DSIN(2.*AJMX)
	CTAIL(I)=C3*(1.-0.31831*(2.*AJMX+STAX)
     *	 -0.21221*STAX*DCOS(AJMX)**2)/X(I)**5
	GOTO26
27	CTAIL(I)=0.3395*C3/X(IMX)**5
26	continue
	DO JR=1,JRMX
	A(JR)=0
	ENDDO
	IF(I.EQ.IMX) GOTO39
	I1=I+1
	M=2
	DO J=I1,IMX
	Y2=DSQRT(X(J)**2-X(I)**2)
	D=1.
	IF(TR(1).LT.0.1) GOTO 34
29	IF(YTR(M).GT.Y2) GOTO 30
	M=M+1
	GOTO 29
30	DYA=YTR(M)-Y2
	DYB=Y2-YTR(M-1)
	DYT=DYA+DYB
	D=(TR(M-1)*DYA+TR(M)*DYB)/DYT
34	DELY=Y2-Y1
	AC(1)=0.5*D*DELY
	AC(2)=AC(1)
	JI=J-1
	IF(DELY.LT.0.1*Y2) GOTO33
	DELX=X(J)-X(JI)
	ARG=X(I)**2*DLOG((X(J)+Y2)/(X(JI)+Y1))
	AC(1)=(0.5*D/DELX)*(X(J)*Y2-2.*Y1*(X(J)-0.5*X(JI))-ARG)
	AC(2)=(0.5*D/DELX)*(X(JI)*Y1-2.*Y2*(X(JI)-0.5*X(J))+ARG)
33	DO 35 JP=JI,J
	L=K(JP)
	JT=JP-JI+1
	A(L)=A(L)+AC(JT)*B1(JP)
	A(L+1)=A(L+1)+AC(JT)*B2(JP)
	A(L+2)=A(L+2)+AC(JT)*B3(JP)
35	CONTINUE
36	Y1=Y2
38	end do
39	DO 40 JR=1,JRMX
	COEF(JR,JRMX1)=COEF(JR,JRMX1)+A(JR)*W*(SMI(I)-CTAIL(I))
	DO 40 KR=1,JRMX
	COEF(JR,KR)=COEF(JR,KR)+A(JR)*W*A(KR)
40	CONTINUE
	IF (IPRINT.NE.2) GOTO45
	PRINT 41,IR
41	FORMAT(' COEFFICIENTS NORMAL EQUATIONS DURING DESMEARING IN 
     *	CYCLE',I4,/)
	DO 42 J=1,JRMX
	PRINT 43,J
43	FORMAT(1X/ 'J.=',I4)
42	PRINT 44,(COEF(J,KK),KK=1,JRMX1)
44	FORMAT(10E12.5)
45	CONTINUE
	CALL DBINVE(JRMX,JRMX1,COEF,KEN,MRAR,MKAR,161,161)
	Print *,' returned from dbinve'
	IF(KEN) 47,50,55
50	DESM(1)=DESM(1)+COEF(1,JRMX1)/N
	DESM(IMX)=DESM(IMX)+COEF(JRMX,JRMX1)/N
	JRMX2=JRMX-1
	DO 60 JR=2,JRMX2
	I=(JR-2)*N+IR+1
60	DESM(I)=COEF(JR,JRMX1)
110	enddo
C
C
C
C	SIMULATED SMEAR CURVE IS NOW CALCULATED
	TEL=0.0
	SROOT=0.0
	SMTOT=0.0
	DO 120 I=1,IMX
	SMCAL(I)=0.0
	Y1=0.0
	I1=I+1
	IF(I.EQ.IMX) GOTO95
	M=2
	DO 90 J=I1,IMX
	Y2=DSQRT((X(J)**2-X(I)**2))
	D=1.0
	IF(TR(1).LT.0.1) GOTO 86
70	IF(YTR(M).GT.Y2) GOTO 160
	M=M+1
	GOTO 70
160	DYA=YTR(M)-Y2
	DYB=Y2-YTR(M-1)
	DYT=DYA+DYB
	D=(TR(M-1)*DYA+TR(M)*DYB)/DYT
86	DELY=Y2-Y1
	AC(1)=0.5*D*DELY
	AC(2)=AC(1)
	JI=J-1
	IF(DELY.LT.0.1*Y2) GOTO 87
	DELX=X(J)-X(JI)
	ARG=X(I)**2*dlog((X(J)+Y2)/(X(JI)+Y1))
	AC(1)=(0.5*D/DELX)*(X(J)*Y2-2.*Y1*(X(J)-0.5*X(JI))-ARG)
	AC(2)=(0.5*D/DELX)*(X(JI)*Y1-2.*Y2*(X(JI)-0.5*X(J))+ARG)
87	SMCAL(I)=SMCAL(I)+AC(1)*DESM(JI)+AC(2)*DESM(J)
88	Y1=Y2
90	CONTINUE
95	SMCAL(I)=SMCAL(I)+CTAIL(I)
C
C	CALCULATE ACCURACYB PARAMETERS
C
	IF(SMCAL(I).LT.0.001) GOTO 120
	DIF=SMI(I)-SMCAL(I)	
	ROOT(I)=DSQRT(SMI(I)+BG)-DSQRT(SMCAL(I)-BG)
	TEL=TEL+DABS(DIF)
	SROOT=SROOT+ROOT(I)**2
	SMTOT=SMTOT+SMI(I)
120	CONTINUE
	RFCT=TEL/SMTOT
	STORT=DSQRT(SROOT/(IMX-2))
	PRINT 130
130	FORMAT(1X,/, 'ACCURACY PARAMETERS OBTAINED DURING SMEARING 
     *	OVER ALL OBSERVATIONS')
	DO KK=1,IMX
		print *,desm(KK)
	END DO
	PRINT 121,RFCT,STORT
121	FORMAT(' R-FACTOR=',F10.4,10X,' ST.DEV.ROOT=',F10.4,/)
	RETURN
47 	PRINT 46
46	FORMAT(' DIMENSIES MATRIX FOUT')
	RETURN
55	PRINT56
56	FORMAT(' SINGULAR MATRIX')
62	N=N+1
	DESM(1)=0.0
	IF(N.GE.9)RETURN
	PRINT 64,N
64	FORMAT(' N INCREASED TO ',I4)
	GOTO 10
	END
C
C
C
C	MATRIX INVERSE SUBROUTINE
	SUBROUTINE DBINVE(N,M,A,KEN,MR,MK,NDIM,MDIM)
	IMPLICIT DOUBLE PRECISION(A-H,O-Z)
	DIMENSION A(ndim,mdim),MR(ndim),MK(ndim)
	KEN=0
	IF(M.GE.N) GOTO 5
	KEN=-1
	RETURN
5	DO 10 I=1,N
	MK(I)=I
10	MR(I)=-I
C	print *,n
	DO 1160 IS=1,N
	SR=0.1D-12
	JS=0
	DO 50 J=1,N
	IF(MK(J).LT.0)GOTO 50
	SA=DABS(A(IS,J))
	IF(SA.LE.SR) GOTO50
	SR=SA
	JS=J
50	CONTINUE
	IF(JS.GT.0) GOTO 70
	KEN=1
	RETURN
70	SP=1.0/A(IS,JS)
	A(IS,JS)=SP
	DO 90 J=1,M
	IF (J-JS) 160,90,160
160	A(IS,J)=A(IS,J)*SP
90	CONTINUE
	DO 150 I=1,N
	IF(I-IS)100,150,100
100	DO 130 j=1,M
	IF(J-JS)120,130,120
120	A(I,J)=A(I,J)-A(I,JS)*A(IS,J)
130	CONTINUE
	A(I,JS)=-A(I,JS)*SP
150	CONTINUE
	MRI=MR(IS)
	MR(IS)=MK(JS)
	MK(JS)=MRI
1160	CONTINUE
	DO 220 I=1,N
	SA=1.0
190	MRI=MR(I)
	IF(MRI.EQ.I)GOTO 220
	DO 200 J=1,M
	SP=A(MRI,J)
	A(MRI,J)=A(J,I)
200	A(I,J)=SP
	MR(I)=MR(MRI)
	MR(MRI)=MRI
	GOTO190
220	CONTINUE
	DO 320 J=1,N
290	MKJ=-MK(J)
	IF(MKJ.EQ.J)GOTO320
	DO 600 I=1,N
	SP=A(I,MKJ)
	A(I,MKJ)=A(I,J)
600	A(I,J)=SP
	MK(J)=MK(MKJ)
	MK(MKJ)=-MKJ
	GOTO290
320	CONTINUE
	RETURN
	END

